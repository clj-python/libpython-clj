FROM clojure:openjdk-11-tools-deps

# set up user
ARG USERID
ARG GROUPID
ARG USERNAME

RUN groupadd -g $GROUPID $USERNAME
RUN useradd -u $USERID -g $GROUPID $USERNAME
RUN mkdir /home/$USERNAME && chown $USERNAME:$USERNAME /home/$USERNAME

# install build depndencies
RUN apt-get update &&\
    apt-get install -y git curl gcc make zlib1g-dev libbz2-dev libreadline-dev libssl-dev python-openssl

# Install pyenv
ENV PYENV_ROOT="/home/pyenv"
ENV PATH="$PYENV_ROOT/bin:$PATH"
ENV PATH="$PYENV_ROOT/shims:$PATH"
RUN curl https://pyenv.run | bash
RUN eval "$(pyenv init -)"

# Install python
ARG PYTHON_VERSION=3.7.6
RUN env PYTHON_CONFIGURE_OPTS="--enable-shared" pyenv install ${PYTHON_VERSION}
RUN pyenv global ${PYTHON_VERSION}

# Install poetry
ENV POETRY_HOME="/home/poetry" \
    POETRY_VIRTUALENVS_IN_PROJECT=true
ENV PATH="$POETRY_HOME/bin:$PATH"
RUN curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python

WORKDIR /home/$USERNAME

# If you don't have pyproject.toml and poetry.lock
RUN poetry new /home/$USERNAME

# Install dependencies in virtual environment
RUN poetry add numpy

# If instead you have application code, deps.edn pyproject.toml and poetry.lock:
# COPY . /app/
# RUN poetry install
EXPOSE 8888

USER $USERNAME
